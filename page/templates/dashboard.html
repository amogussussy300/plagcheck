{% extends "base.html" %}

{% block content %}

<!-- это чудо что это "работает" -->

<div class="dashboard-container">
  <div class="dashboard-content">

    <h2>Добро пожаловать, {{ current_user.username }}!</h2>

    <!-- drag n drop -->
    <div class="drag-drop-zone" id="dropZone">
      <div class="drop-instructions">
        <i class="fas fa-cloud-upload-alt fa-3x"></i>
        <p>Перетащите сюда архив</p>
        <p>или</p>
        <button class="btn-browse" onclick="document.getElementById('fileInput').click()">
          найти архив
        </button>
        <input type="file" id="fileInput" hidden>
      </div>
    </div>

    <!-- Работа с загруженными архивами и предыдущими архивами -->
    <div id="uploadedFiles" class="uploaded-files" style="display: none; margin-top:2rem;">
      <h3>Ваши архивы: <span id="archiveCounter">{{ counter }} / 10</span></h3>
      <div id="taskLinkContainer"></div>
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            {% for archive in archives %}
              renderTaskLink({{ archive|tojson }});
            {% endfor %}
          });
        </script>
    </div>

    <!-- контейнер с результатом обработки -->
    <div id="comparisons" style="display:none; margin-top:2rem;"></div>

    <!-- spinner -->
    <div id="loading-spinner" style="display:none; text-align:center; margin-top:1em;">
      <div class="spinner"></div>
    </div>
  </div>
</div>


<style>

    .drag-drop-zone {
        border: 2px dashed #3498db;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        margin: 2rem 0;
        transition: all 0.3s ease;
    }

    .drag-drop-zone.dragover {
        background: #f8f9fa;
        border-color: #2980b9;
    }

    .btn-browse {
        background: #3498db;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }

    .uploaded-files {
        margin-top: 2rem;
    }

    .file-list {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 1rem;
        margin-top: 1rem;
    }

    #loading-spinner {
      display: none;
      text-align: center;
      margin-top: 1em;
    }

    .spinner {
      width: 2rem;
      height: 2rem;
      border: 0.3rem solid rgba(0, 0, 0, 0.1);
      border-top-color: #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: auto;
    }

    @keyframes spin {
    to { transform: rotate(360deg); }
    }

    .toggle-arrow {
      transform-origin: center;
      transition: transform 0.2s;
      display: inline-block;
    }

    .delete-archive {
      transform-origin: right;
      transition: transform 0.2s;
      display: inline-block;
    }

    .delete-archive:hover {
      transform: scale(1.2);
    }

    .toggleArrow.expanded {
      transform: rotate(90deg);
    }

    .task-item {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
    }

    .task-id {
        color: #3498db;
        cursor: pointer;
        font-weight: 500;
    }

    .task-id:hover {
        text-decoration: underline;
    }

    .results-data {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
        white-space: pre-wrap;
        font-family: monospace;
    }

    .comparison-pair {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .code-block {
      flex: 1;
      background: #f7f7f7;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 1rem;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-x: auto;
    }

    .comparison-meta {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }

    .sfh-flag {
      background-color: #ffe5e5;
      border-radius: 2px;
      padding: 0 2px;
    }

    .toggle-container {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

    .toggle-arrow {
    transition: transform 0.2s;
    display: inline-block;
  }

    .fileLink {
    color: #3498db;
    text-decoration: none;
    cursor: pointer;
  }

  .fileResults {
    margin-top: 1rem;
    border-left: 3px solid #3498db;
    padding-left: 1rem;
  }

    .task-header {
    cursor: pointer;
    padding: 8px 12px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin: 8px 0;
    display: flex;
    align-items: center;
  }

  .task-header:hover {
    background: #eee;
  }

  .toggle-arrow {
    display: inline-block;
    margin-right: 8px;
    transition: transform 0.2s ease;
  }

  .task-content {
    margin-left: 20px;
    border-left: 2px solid #ddd;
    padding-left: 12px;
  }

  .drag-drop-zone.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
  }

</style>


<script>
  const el = {
    dropZone: document.getElementById('dropZone'),
    fileInput: document.getElementById('fileInput'),
    spinner: document.getElementById('loading-spinner'),
    uploadedSection: document.getElementById('uploadedFiles'),
    taskLinkContainer: document.getElementById('taskLinkContainer'),
    comparisons: document.getElementById('comparisons')
  };

  let isUploading = false;
  const RENDER_CHUNK_SIZE = 15;
  const YIELD_TIME = 50;
  const counterElement = document.getElementById('archiveCounter');
  var archiveCounter = 0;


  document.addEventListener('DOMContentLoaded', () => {
    archiveCounter = document.querySelectorAll('.archive-item').length;
    updateCounter();
  });

  function updateCounter() {
    counterElement.textContent = `${archiveCounter} / 10`;
  }

  const handleDrag = (e) => {
    e.preventDefault();
    e.stopPropagation();
    el.dropZone.classList.toggle('dragover', ['dragenter', 'dragover'].includes(e.type));
  };

  if (el.dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt =>
      el.dropZone.addEventListener(evt, handleDrag)
    );
  }
  el.dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
  el.fileInput.addEventListener('change', () => handleFiles(el.fileInput.files));

  let lastResult = null;

  async function handleFiles(files) {
    if (isUploading) return;

    if (!files.length) return;

    if (archiveCounter >= 10) {
      console.error('Достигнут лимит архивов в 10');
      return;
    }

    el.spinner.style.display = 'block';
    el.comparisons.style.display = 'none';

    try {
      isUploading = true;
      el.dropZone.classList.add('disabled', 'uploading');
      const formData = new FormData();
      formData.append('archive', files[0]);

      const response = await fetch('/upload', { method: 'POST', body: formData });
      const responseData = await response.json();
      lastResult = responseData.status_data;
      if (responseData.new_count != null) {
        archiveCounter = responseData.new_count;
      }

      updateCounter();

      renderTaskLink(lastResult, true);
      el.uploadedSection.style.display = 'block';
    } catch (error) {
      console.error('Ошибка загрузки:', error);
    } finally {
      isUploading = false;
      el.dropZone.classList.remove('disabled', 'uploading');
      el.spinner.style.display = 'none';
    }
  }

  function renderTaskLink(data, prepend = false) {

    if (!data?.task_id || !data?.status) {
      console.error('неверные данные архива:', data);
      alert("Вы слишком часто отправляли архивы на обработку! Подождите минуту (лимит api - 4 архива в минуту).");
      return;
    }

    // const uploadTime = data.created_at
    const uploadTime = data.created_at ?
    new Date(data.created_at).toLocaleString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }) : 'Недавно';
    const archName = data.archive_name

    const containerId = `taskToggle-${data.task_id}`;
    const arrowId = `toggleArrow-${data.task_id}`;
    const deleteId = `delete-${data.task_id}`;

    const taskDiv = document.createElement('div');
    taskDiv.className = 'archive-item';
    taskDiv.innerHTML = `
      <div class="toggle-container" id="${containerId}">
        <span class="toggle-arrow" id="${arrowId}">▶</span>
        <a href="#">${formatFileName(archName)} ${uploadTime}</a>
        <span class="delete-archive" id="${deleteId}">
          <i class="fas fa-trash-alt"></i>
        </span>
      </div>
      <div class="comparisons" style="display: none;"></div>
    `;

    if (prepend) {
      el.taskLinkContainer.insertBefore(taskDiv, el.taskLinkContainer.firstChild);
      } else {
        el.taskLinkContainer.appendChild(taskDiv);
      }

    updateCounter();

    const toggleContainer = taskDiv.querySelector('.toggle-container');
    const comparisonsDiv = taskDiv.querySelector('.comparisons');

    const deleteBtn = taskDiv.querySelector(`#${deleteId}`);
    deleteBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (confirm('Вы точно хотите удалить архив?')) {
            try {
                const response = await fetch(`/delete/${data.task_id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        taskDiv.remove();
                        archiveCounter = result.new_count;
                        updateCounter();

                        if (!el.taskLinkContainer.children.length) {
                            el.uploadedSection.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.error('Deletion error:', error);
            }
        }
    });

    toggleContainer.addEventListener('click', (e) => {
      e.preventDefault();
      const arrow = e.currentTarget.querySelector('.toggle-arrow');
      const isOpen = comparisonsDiv.style.display === 'block';

      arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
      comparisonsDiv.style.display = isOpen ? 'none' : 'block';

      if (!isOpen && !comparisonsDiv.innerHTML) {
        renderComparisons(data, comparisonsDiv);
      }
    });

    el.uploadedSection.style.display = 'block';
  }

async function renderComparisons(data, targetElement) {
  if (!data?.results) return;

  const { copydetect = {}, vector = {} } = data.results;
  targetElement.innerHTML = '<div class="loading-text">обрабатываем блоки сравнения...</div>';

  const tasks = {};
  Object.entries(copydetect).forEach(([pairKey, cdVals]) => {
    const taskId = pairKey.split('___')[0];
    tasks[taskId] = tasks[taskId] || [];
    tasks[taskId].push({ pairKey, cdVals });
  });
  const sortedTasks = Object.keys(tasks).sort((a, b) => a.localeCompare(b));

  const fragment = document.createDocumentFragment();

  for (const taskId of sortedTasks) {
    const taskContainer = document.createElement('div');
    taskContainer.className = 'task-container';

    const taskHeader = document.createElement('div');
    taskHeader.className = 'task-header';
    taskHeader.innerHTML = `
      <span class="toggle-arrow">▶</span>
      Задачка ${taskId}
      <span class="loading-dots" style="display: none">...</span>
    `;

    const content = document.createElement('div');
    content.className = 'task-content';
    content.style.display = 'none';

    let pairs = tasks[taskId];
    let renderedPairs = 0;
    let isRendering = false;

    taskHeader.addEventListener('click', async () => {
      const isOpen = content.style.display === 'block';
      content.style.display = isOpen ? 'none' : 'block';
      taskHeader.querySelector('.toggle-arrow').style.transform =
        isOpen ? 'rotate(0deg)' : 'rotate(90deg)';

      if (!isOpen && !content.hasChildNodes()) {
        const loader = taskHeader.querySelector('.loading-dots');
        loader.style.display = 'inline';
        isRendering = true;

        while (renderedPairs < pairs.length) {
          const chunk = pairs.slice(renderedPairs, renderedPairs + RENDER_CHUNK_SIZE);
          renderedPairs += chunk.length;

          const chunkFragment = document.createDocumentFragment();
          chunk.forEach(({ pairKey, cdVals }) => {
            const [tokens, score, [codeA, codeB]] = cdVals;
            const [,, fileA, fileB] = pairKey.split('___');
            const vecScore = vector[pairKey] ?? '—';

            const pair = document.createElement('div');
            pair.className = 'comparison-pair';
            pair.innerHTML = `
              ${createCodeBlock(fileA, tokens, score, vecScore, codeA)}
              ${createCodeBlock(fileB, tokens, score, vecScore, codeB)}
            `;
            chunkFragment.appendChild(pair);
          });

          content.appendChild(chunkFragment);
          await new Promise(resolve => setTimeout(resolve, YIELD_TIME));
        }

        loader.style.display = 'none';
        isRendering = false;
      }
    });

    taskContainer.appendChild(taskHeader);
    taskContainer.appendChild(content);
    fragment.appendChild(taskContainer);

    await new Promise(resolve => setTimeout(resolve, YIELD_TIME));
  }

  targetElement.innerHTML = '';
  targetElement.appendChild(fragment);
}


function createCodeBlock(filename, tokens, score, vecScore, code) {
  const formattedVec = typeof vecScore === 'number'
    ? vecScore.toFixed(3)
    : vecScore;

  return `
    <div class="code-block">
      <div class="comparison-meta">
        <strong>${filename.replace(/[-_]/g, ' ')}</strong><br>
        Copydetect: t=${tokens}, s=${score.toFixed(3)}<br>
        Vector: ${formattedVec}
      </div>
      <pre>${highlightSFH(escapeHtml(code))}</pre>
    </div>
  `;
}

  const escapeHtml = str => str.replace(/[&<>]/g,
    c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]));

  const highlightSFH = code => code.replace(
    /~~SFH~~(.*?)~~SFH~~/gs,
    (_, match) => `<span class="sfh-flag">${match}</span>`
  );

  function formatFileName(filename) {

    const lastDotIndex = filename.lastIndexOf('.');

    if (lastDotIndex === -1) {
        return filename.length > 16
            ? `${filename.slice(0, 13)}...`
            : filename;
    }

    const namePart = filename.slice(0, lastDotIndex);
    const extension = filename.slice(lastDotIndex + 1);

    if (namePart.length > 16) {
        return `${namePart.slice(0, 13)}... .${extension}`;
    }

    return filename;
  }


</script>



<!-- font-awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

{% endblock %}