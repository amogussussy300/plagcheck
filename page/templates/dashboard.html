{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-content">
    <h2>Добро пожаловать, {{ current_user.username }}!</h2>

    <!-- drag n drop -->
    <div class="drag-drop-zone" id="dropZone">
      <div class="drop-instructions">
        <i class="fas fa-cloud-upload-alt fa-3x"></i>
        <p>Перетащите сюда архив</p>
        <p>или</p>
        <button class="btn-browse" onclick="fileInput.click()">
          найти архив
        </button>
        <input type="file" id="fileInput" hidden>
      </div>
    </div>

    <!-- spinner -->
    <div id="loading-spinner" style="display:none; text-align:center; margin-top:1em;">
      <div class="spinner"></div>
    </div>

    <!-- работа с загруженными архивами (доделать) -->
    <div class="uploaded-files" id="uploadedFiles" style="display:none; margin-top:2rem;">
      <h3>Ваши архивы</h3>
      <div id="taskLinkContainer"></div>
      </div>
    </div>

    <!-- контейнер с результатом обработки -->
    <div id="comparisons" style="display:none; margin-top:2rem;"></div>
  </div>
</div>

<style>

    .drag-drop-zone {
        border: 2px dashed #3498db;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        margin: 2rem 0;
        transition: all 0.3s ease;
    }

    .drag-drop-zone.dragover {
        background: #f8f9fa;
        border-color: #2980b9;
    }

    .btn-browse {
        background: #3498db;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }

    .uploaded-files {
        margin-top: 2rem;
    }

    .file-list {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 1rem;
        margin-top: 1rem;
    }

    #loading-spinner {
      display: none;
      text-align: center;
      margin-top: 1em;
    }

    .spinner {
      width: 2rem;
      height: 2rem;
      border: 0.3rem solid rgba(0, 0, 0, 0.1);
      border-top-color: #333;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: auto;
    }

    @keyframes spin {
    to { transform: rotate(360deg); }
    }

    #toggleArrow {
      display: inline-block;
      transform-origin: center;
    }

    #toggleArrow.expanded {
      transform: rotate(90deg);
    }

    .task-item {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
    }

    .task-id {
        color: #3498db;
        cursor: pointer;
        font-weight: 500;
    }

    .task-id:hover {
        text-decoration: underline;
    }

    .results-data {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
        white-space: pre-wrap;
        font-family: monospace;
    }

    .comparison-pair {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .code-block {
      flex: 1;
      background: #f7f7f7;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 1rem;
      font-family: monospace;
      white-space: pre-wrap;
      overflow-x: auto;
    }

    .comparison-meta {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }

    .sfh-flag {
      background-color: #ffe5e5;
      border-radius: 2px;
      padding: 0 2px;
    }

</style>

<script>
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const spinner = document.getElementById('loading-spinner');
  const uploadedSection = document.getElementById('uploadedFiles');
  const taskLinkContainer = document.getElementById('taskLinkContainer');
  const comparisonsContainer = document.getElementById('comparisons');

  ['dragenter','dragover','dragleave','drop'].forEach(evt => {
    dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); });
  });
  ['dragenter','dragover'].forEach(evt =>
    dropZone.addEventListener(evt, () => dropZone.classList.add('dragover'))
  );
  ['dragleave','drop'].forEach(evt =>
    dropZone.addEventListener(evt, () => dropZone.classList.remove('dragover'))
  );
  dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
  fileInput.addEventListener('change', () => handleFiles(fileInput.files));

  let lastResult = null;

  async function handleFiles(files) {
    if (!files.length) return;

    spinner.style.display = 'block';
    uploadedSection.style.display = 'none';
    comparisonsContainer.style.display = 'none';
    taskLinkContainer.innerHTML = '';

    const file = files[0];
    const fd = new FormData();
    fd.append('archive', file, file.name);

    try {
      const res = await fetch('/upload', { method: 'POST', body: fd });
      const data = await res.json();
      lastResult = data;

      taskLinkContainer.innerHTML = `
        <div id="taskToggle" style="cursor:pointer; display:inline-flex; align-items:center; gap:0.5rem;">
          <span id="toggleArrow" style="transition: transform 0.2s;">▶</span>
          <a href="#" id="taskToggleLink">${data.task_id}_${data.status}</a>
        </div>
      `;
      uploadedSection.style.display = 'block';

      document.getElementById('taskToggle').addEventListener('click', function(evt) {
        evt.preventDefault();
        const arrow = document.getElementById('toggleArrow');
        const isOpen = comparisonsContainer.style.display === 'block';

        comparisonsContainer.style.display = isOpen ? 'none' : 'block';

        arrow.classList.toggle('expanded', !isOpen);

        if (!isOpen && !comparisonsContainer.hasChildNodes()) {
          renderComparisons(evt);
        }
      });

      uploadedSection.style.display = 'block';
    } catch (err) {
      console.error('Upload failed:', err);
    } finally {
      spinner.style.display = 'none';
    }
  }

  function renderComparisons(evt) {
    evt.preventDefault();
    if (!lastResult || !lastResult.results) return;

    comparisonsContainer.innerHTML = '';
    const { copydetect = {}, vector = {} } = lastResult.results;

    Object.entries(copydetect).forEach(([pairKey, cdVals]) => {
      const [tokens, score, [codeA, codeB]] = cdVals;
      const vecScore = vector[pairKey] ?? '—';

      const pairDiv = document.createElement('div');
      pairDiv.classList.add('comparison-pair');

      const leftDiv = document.createElement('div');
      leftDiv.classList.add('code-block');
      leftDiv.innerHTML =
        `<div class="comparison-meta">
           <strong>${pairKey.split('___')[2].replace(/-/g,' ')}</strong><br>
           CopyDetect: tokens=${tokens}, score=${score}<br>
           Vector: ${vecScore}
         </div>` +
        `<pre>${highlightSFH(codeA)}</pre>`;

      const rightDiv = document.createElement('div');
      rightDiv.classList.add('code-block');
      rightDiv.innerHTML =
        `<div class="comparison-meta">
           <strong>${pairKey.split('___')[3].replace(/-/g,' ')}</strong><br>
           CopyDetect: tokens=${tokens}, score=${score}<br>
           Vector: ${vecScore}
         </div>` +
        `<pre>${highlightSFH(codeB)}</pre>`;

      pairDiv.appendChild(leftDiv);
      pairDiv.appendChild(rightDiv);
      comparisonsContainer.appendChild(pairDiv);
    });

    comparisonsContainer.style.display = 'block';
    comparisonsContainer.scrollIntoView({ behavior: 'smooth' });
  }

  function escapeHtml(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function highlightSFH(code) {
    const escaped = escapeHtml(code);
    return escaped.replace(
      /~~SFH~~(.*?)~~SFH~~/gs,
      (_, inner) => `<span class="sfh-flag">${inner}</span>`
    );
  }
</script>

<!-- font-awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

{% endblock %}